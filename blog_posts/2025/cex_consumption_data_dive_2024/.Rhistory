) %>%
mutate(food_total = food_at_home + food_away)
fmli <- read_csv(
fmli_file,
show_col_types = FALSE,
col_types = cols(newid = col_character(), .default = col_guess())
) %>%
clean_names()
d_q <- fmli %>%
select(newid, finlwt21) %>%
left_join(food_q, by = "newid") %>%
mutate(
food_at_home = replace_na(food_at_home, 0),
food_away    = replace_na(food_away, 0),
food_total   = replace_na(food_total, 0)
)
probs <- c(.10, .25, .50, .75, .90, .95, .99)
out <- tibble(
stat = c(
paste0("p", probs * 100),
"weighted_mean",
"unweighted_mean",
"n_cu"
),
food_total = c(
as.numeric(wtd.quantile(d_q$food_total, d_q$finlwt21, probs)),
wtd.mean(d_q$food_total, d_q$finlwt21),
mean(d_q$food_total),
nrow(d_q)
),
food_at_home = c(
as.numeric(wtd.quantile(d_q$food_at_home, d_q$finlwt21, probs)),
wtd.mean(d_q$food_at_home, d_q$finlwt21),
mean(d_q$food_at_home),
nrow(d_q)
),
food_away = c(
as.numeric(wtd.quantile(d_q$food_away, d_q$finlwt21, probs)),
wtd.mean(d_q$food_away, d_q$finlwt21),
mean(d_q$food_away),
nrow(d_q)
)
)
out
mt_food %>%
filter(food_type == "food_away") %>%
count(expname, rtype, sort = TRUE) %>%
slice_head(n = 20)
mt_food %>%
filter(food_type == "food_away")
mt_food %>%
filter(food_type == "food_away") %>%
count(expname, ucc, sort = TRUE) %>%
slice_head(n = 20)
mt_food %>%
filter(food_type == "food_away") %>%
count(ucc, sort = TRUE) %>%
slice_head(n = 20)
library(tidyverse)
library(janitor)
library(Hmisc)
library(cepumd)
library(tidyverse)
library(janitor)
library(Hmisc)
library(cepumd)
bls_food_crosswalk <- c(
# Food at home
"CXUFOODHOMELB0102M" = "Food at home: Lowest 20 percent income quintile",
"CXUFOODHOMELB0103M" = "Food at home: Second 20 percent income quintile",
"CXUFOODHOMELB0104M" = "Food at home: Third 20 percent income quintile",
"CXUFOODHOMELB0105M" = "Food at home: Fourth 20 percent income quintile",
"CXUFOODHOMELB0106M" = "Food at home: Highest 20 percent income quintile",
# Food away from home
"CXUFOODAWAYLB0102M" = "Food away from home: Lowest 20 percent income quintile",
"CXUFOODAWAYLB0103M" = "Food away from home: Second 20 percent income quintile",
"CXUFOODAWAYLB0104M" = "Food away from home: Third 20 percent income quintile",
"CXUFOODAWAYLB0105M" = "Food away from home: Fourth 20 percent income quintile",
"CXUFOODAWAYLB0106M" = "Food away from home: Highest 20 percent income quintile"
)
library(tidyverse)
library(janitor)
library(Hmisc)
library(cepumd)
bls_food_crosswalk <- c(
# Food at home
"CXUFOODHOMELB0102M" = "Food at home: Lowest 20 percent income quintile",
"CXUFOODHOMELB0103M" = "Food at home: Second 20 percent income quintile",
"CXUFOODHOMELB0104M" = "Food at home: Third 20 percent income quintile",
"CXUFOODHOMELB0105M" = "Food at home: Fourth 20 percent income quintile",
"CXUFOODHOMELB0106M" = "Food at home: Highest 20 percent income quintile",
# Food away from home
"CXUFOODAWAYLB0102M" = "Food away from home: Lowest 20 percent income quintile",
"CXUFOODAWAYLB0103M" = "Food away from home: Second 20 percent income quintile",
"CXUFOODAWAYLB0104M" = "Food away from home: Third 20 percent income quintile",
"CXUFOODAWAYLB0105M" = "Food away from home: Fourth 20 percent income quintile",
"CXUFOODAWAYLB0106M" = "Food away from home: Highest 20 percent income quintile"
)
library(blsAPI)
# Install and load blsR if you haven't already
# install.packages("blsR")
library(blsR)
library(dplyr)
# 1. Define your Series IDs
food_series_ids <- c(
"CXUFOODHOMELB0102M", "CXUFOODHOMELB0103M", "CXUFOODHOMELB0104M",
"CXUFOODHOMELB0105M", "CXUFOODHOMELB0106M",
"CXUFOODAWAYLB0102M", "CXUFOODAWAYLB0103M", "CXUFOODAWAYLB0104M",
"CXUFOODAWAYLB0105M", "CXUFOODAWAYLB0106M"
)
# 2. Define the naming crosswalk
bls_food_names <- c(
"CXUFOODHOMELB0102M" = "Home: Lowest 20%",
"CXUFOODHOMELB0103M" = "Home: Second 20%",
"CXUFOODHOMELB0104M" = "Home: Third 20%",
"CXUFOODHOMELB0105M" = "Home: Fourth 20%",
"CXUFOODHOMELB0106M" = "Home: Highest 20%",
"CXUFOODAWAYLB0102M" = "Away: Lowest 20%",
"CXUFOODAWAYLB0103M" = "Away: Second 20%",
"CXUFOODAWAYLB0104M" = "Away: Third 20%",
"CXUFOODAWAYLB0105M" = "Away: Fourth 20%",
"CXUFOODAWAYLB0106M" = "Away: Highest 20%"
)
# 3. Request the data
# blsR's get_n_series_table handles multiple IDs and returns a clean data frame
food_data_raw <- get_n_series_table(
food_series_ids,
start_year = 2014,
end_year = 2024,
# api_key = "YOUR_API_KEY" # Optional: add your key here to get more than 2 years
)
# 4. Rename and Tidy the data
food_data_final <- food_data_raw %>%
rename_with(~ bls_food_names[.x], .cols = any_of(names(bls_food_names))) %>%
tidyr::pivot_longer(
cols = starts_with(c("Home", "Away")),
names_to = "Category_Quintile",
values_to = "Expenditure"
) %>%
tidyr::separate(Category_Quintile, into = c("Location", "Quintile"), sep = ": ")
# Preview results
print(head(food_data_final))
food_data_final
food_data_raw
library(blsR)
library(dplyr)
library(tidyr)
# 1. Define the complete Series ID list
# We add CXUTOTALEXP... for the quintiles
food_series_ids <- c(
# Food at Home
"CXUFOODHOMELB0102M", "CXUFOODHOMELB0103M", "CXUFOODHOMELB0104M", "CXUFOODHOMELB0105M", "CXUFOODHOMELB0106M",
# Food Away from Home
"CXUFOODAWAYLB0102M", "CXUFOODAWAYLB0103M", "CXUFOODAWAYLB0104M", "CXUFOODAWAYLB0105M", "CXUFOODAWAYLB0106M",
# Total Expenditures
"CXUTOTALEXPLB0102M", "CXUTOTALEXPLB0103M", "CXUTOTALEXPLB0104M", "CXUTOTALEXPLB0105M", "CXUTOTALEXPLB0106M"
)
# 2. Map IDs to readable labels
bls_map <- c(
"CXUFOODHOMELB"  = "Food_Home",
"CXUFOODAWAYLB"  = "Food_Away",
"CXUTOTALEXPLB"  = "Total_Exp"
)
quintile_map <- c(
"0102M" = "Lowest 20%",
"0103M" = "Second 20%",
"0104M" = "Third 20%",
"0105M" = "Fourth 20%",
"0106M" = "Highest 20%"
)
# 3. Request data
# Note: For years 2014-2024, an API key is highly recommended
raw_data <- get_n_series_table(
food_series_ids,
start_year = 2014,
end_year = 2024
)
# 4. Tidy and Calculate Percentages
food_analysis <- raw_data %>%
pivot_longer(cols = -year, names_to = "series_id", values_to = "value") %>%
mutate(
# Extract prefix and suffix to identify category and quintile
category_id = substr(series_id, 1, 13),
quintile_id = substr(series_id, 14, 18),
category    = bls_map[category_id],
quintile    = quintile_map[quintile_id]
) %>%
select(year, quintile, category, value) %>%
# Spread categories into columns to calculate percentages
pivot_wider(names_from = category, values_from = value) %>%
mutate(
pct_food_home  = (Food_Home / Total_Exp) * 100,
pct_food_away  = (Food_Away / Total_Exp) * 100,
pct_total_food = ((Food_Home + Food_Away) / Total_Exp) * 100
)
library(blsR)
library(dplyr)
library(tidyr)
# 1. Define the complete Series ID list
food_series_ids <- c(
"CXUFOODHOMELB0102M", "CXUFOODHOMELB0103M", "CXUFOODHOMELB0104M", "CXUFOODHOMELB0105M", "CXUFOODHOMELB0106M",
"CXUFOODAWAYLB0102M", "CXUFOODAWAYLB0103M", "CXUFOODAWAYLB0104M", "CXUFOODAWAYLB0105M", "CXUFOODAWAYLB0106M",
"CXUTOTALEXPLB0102M", "CXUTOTALEXPLB0103M", "CXUTOTALEXPLB0104M", "CXUTOTALEXPLB0105M", "CXUTOTALEXPLB0106M"
)
# 2. Request data
# Note: Without a key, BLS API defaults to the most recent 2 years.
raw_data <- get_n_series_table(
food_series_ids,
start_year = 2014,
end_year = 2024
)
# 3. Tidy and Calculate Percentages
food_analysis <- raw_data %>%
# FIX: Exclude both 'year' AND 'period' from the pivot
pivot_longer(
cols = -c(year, period),
names_to = "series_id",
values_to = "value"
) %>%
mutate(
# Identify the category based on the Series ID string
category = case_when(
grepl("FOODHOME", series_id) ~ "Food_Home",
grepl("FOODAWAY", series_id) ~ "Food_Away",
grepl("TOTALEXP", series_id) ~ "Total_Exp"
),
# Identify the quintile based on the suffix
quintile = case_when(
grepl("0102M$", series_id) ~ "Lowest 20%",
grepl("0103M$", series_id) ~ "Second 20%",
grepl("0104M$", series_id) ~ "Third 20%",
grepl("0105M$", series_id) ~ "Fourth 20%",
grepl("0106M$", series_id) ~ "Highest 20%"
)
) %>%
filter(!is.na(value)) %>%
select(year, quintile, category, value) %>%
# Spread categories into columns
pivot_wider(names_from = category, values_from = value) %>%
# Calculate budget shares
mutate(
pct_food_home  = (Food_Home / Total_Exp) * 100,
pct_food_away  = (Food_Away / Total_Exp) * 100,
pct_total_food = ((Food_Home + Food_Away) / Total_Exp) * 100
)
# Preview the results
print(food_analysis %>% arrange(year, quintile))
ggplot(food_analysis, aes(year, pct_total_food)) + geom_line() +
facet_wrap(~quintile)
ggplot(food_analysis, aes(year, Food_Home)) + geom_line() +
facet_wrap(~quintile)
ggplot(food_analysis, aes(year, Food_Away)) + geom_line() +
facet_wrap(~quintile)
ggplot(food_analysis, aes(year, Total_Exp)) + geom_line() +
facet_wrap(~quintile)
ggplot(food_analysis, aes(year, pct_food_home)) + geom_line() +
facet_wrap(~quintile)
ggplot(food_analysis, aes(year, Food_Away)) + geom_line() +
facet_wrap(~quintile)
ggplot(food_analysis, aes(year, pct_food_away)) + geom_line() +
facet_wrap(~quintile)
ggplot(food_analysis, aes(year, pct_food_home)) + geom_line() +
facet_wrap(~quintile)
library(tidyverse)
library(janitor)
library(tidyusmacro)
library(tibble)
df_items <- tibble::tibble(
item = c(
"Number of consumer units (in thousands)(a)",
"Average income before taxes",
"Average annual expenditures",
"Food",
"Food at home",
"Cereals and bakery products",
"Meats, poultry, fish, and eggs",
"Dairy products",
"Fruits and vegetables",
"Other food at home",
"Food away from home",
"Alcoholic beverages",
"Housing",
"Owned dwellings",
"Rented dwellings",
"Other lodging",
"Apparel and services",
"Transportation",
"Vehicle purchases (net outlay)",
"Gasoline",
"Other vehicle expenses",
"Vehicle insurance",
"Public and other transportation",
"Healthcare",
"Health insurance",
"Medical services",
"Drugs",
"Medical supplies",
"Entertainment",
"Personal care products and services",
"Reading",
"Education",
"Tobacco products and smoking supplies",
"Miscellaneous",
"Cash contributions",
"Personal insurance and pensions",
"Life and other personal insurance",
"Retirement, pensions, and Social Security",
"Contributions to retirement plans",
"Deductions for Social Security"
),
indent = c(
0,
0,
0,
0,
1,
2,
2,
2,
2,
2,
1,
0,
0,
1,
1,
1,
0,
0,
1,
2,
1,
2,
1,
0,
1,
1,
1,
1,
0,
0,
0,
0,
0,
0,
0,
0,
1,
1,
2,
2
)
)
df_items %>% filter(indent == 0)
demographics_characteristics <- tibble(
demographics_code = c("LB01", "LB01", "LB01", "LB01", "LB01", "LB01", "LB04"),
characteristics_code = c("01", "02", "03", "04", "05", "06", "03"),
filtered_keep = 1
)
cex_org <- getBLSFiles("cex", "konczal@gmail.com")
cex <- cex_org %>% select(!ends_with(".x")) %>% select(!ends_with(".y"))
total_expend_cat <- c(
"CXUTOTALEXPLB0101M",
"CXUTOTALEXPLB0102M",
"CXUTOTALEXPLB0103M",
"CXUTOTALEXPLB0104M",
"CXUTOTALEXPLB0105M",
"CXUTOTALEXPLB0106M"
)
cex %>%
filter(series_id %in% total_expend_cat)
library(tidyverse)
cex <- read_csv("data/cex_data.csv")
cex
distinct(cex$item_text)
unique(cex$item_text)
library(tidyverse)
library(janitor)
library(tidyusmacro)
library(tibble)
led <- read_csv("data/cex_data.csv"))
led <- read_csv("data/cex_data.csv")
led
led %>% filter(item_name %in% c(    "Food at home",
"Food away from home"))
led %>% filter(item_text %in% c(    "Food at home",
"Food away from home"))
led %>% filter(item_text %in% c(    "Food at home",
"Food away from home"),
characteristics_text != "All Consumer Units")
led %>% filter(item_text %in% c(    "Food at home",
"Food away from home"),
characteristics_text != "All Consumer Units") %>%
select(year, value, item_text, total_expend)
led %>% filter(item_text %in% c(    "Food at home",
"Food away from home"),
characteristics_text != "All Consumer Units") %>%
select(year, value, item_text, characteristics_text, total_expend)
led <- led %>% filter(item_text %in% c(    "Food at home",
"Food away from home"),
characteristics_text != "All Consumer Units") %>%
select(year, value, item_text, characteristics_text, total_expend)
getFRED(all_less_food = "CPIULFSL", food_away_from_home = "CUSR0000SEFV", food_at_home = "CUSR0000SAF11")
food_prices <- getFRED(all_less_food = "CPIULFSL", food_away_from_home = "CUSR0000SEFV", food_at_home = "CUSR0000SAF11")
#| echo: false
library(tidyverse)
library(tidyusmacro)
median <- getFRED(real_median = "MEHOINUSA672N")
cex <- read_csv("data/cex_data.csv") %>% filter(demographics_text != "Age of reference person")
median
#| echo: false
library(tidyverse)
library(tidyusmacro)
median <- getFRED(real_median = "MEHOINUSA672N")
cex <- read_csv("data/cex_data.csv") %>% filter(demographics_text != "Age of reference person")
#| fig-width: 8.5
#| fig-height: 6.5
ggplot(median_income %>% filter(date >= as.Date("2000-01-01")),
aes(x = date, y = value)) +
geom_line(color = "#1F5A7A", linewidth = 1.6) +
geom_point(
data = median_income %>% slice_tail(n = 1),
color = "#1F5A7A",
size = 2.6
) +
scale_x_date(date_breaks = "5 years", date_labels = "%Y") +
scale_y_continuous(labels = scales::dollar_format(scale = 1 / 1000, suffix = "k")) +
labs(
title = "Graphic 1: Real Median Household Income in the United States",
subtitle = "Inflation-adjusted dollars (Census definition)",
x = NULL,
y = "Median household income",
caption = "Source: U.S. Census Bureau; Mike Konczal."
) +
theme_minimal(base_size = 13) +
theme(
plot.title.position = "plot",
panel.grid.minor = element_blank(),
axis.text.x = element_text(size = 11),
axis.text.y = element_text(size = 11)
)
#| echo: false
library(tidyverse)
median_income <- read_csv("data/real_median_household_income.csv") %>%
mutate(date = as.Date(date))
cex <- read_csv("data/cex_data.csv") %>% filter(demographics_text != "Age of reference person")
#| fig-width: 8.5
#| fig-height: 6.5
ggplot(median_income %>% filter(date >= as.Date("2000-01-01")),
aes(x = date, y = value)) +
geom_line(color = "#1F5A7A", linewidth = 1.6) +
geom_point(
data = median_income %>% slice_tail(n = 1),
color = "#1F5A7A",
size = 2.6
) +
scale_x_date(date_breaks = "5 years", date_labels = "%Y") +
scale_y_continuous(labels = scales::dollar_format(scale = 1 / 1000, suffix = "k")) +
labs(
title = "Graphic 1: Real Median Household Income in the United States",
subtitle = "Inflation-adjusted dollars (Census definition)",
x = NULL,
y = "Median household income",
caption = "Source: U.S. Census Bureau; Mike Konczal."
) +
theme_minimal(base_size = 13) +
theme(
plot.title.position = "plot",
panel.grid.minor = element_blank(),
axis.text.x = element_text(size = 11),
axis.text.y = element_text(size = 11)
)
ggplot(median_income %>% filter(date >= as.Date("2000-01-01")),
aes(x = date, y = value)) +
geom_line(color = "#1F5A7A", linewidth = 1.6) +
geom_point(
data = median_income %>% slice_tail(n = 1),
color = "#1F5A7A",
size = 2.6
) +
scale_x_date(date_breaks = "5 years", date_labels = "%Y") +
scale_y_continuous(labels = scales::dollar_format(scale = 1 / 1000, suffix = "k")) +
labs(
title = "Graphic 1: Real Median Household Income in the United States",
subtitle = "Inflation-adjusted dollars (Census definition)",
x = NULL,
y = "Median household income",
caption = "Source: U.S. Census Bureau; Mike Konczal."
) +
theme_minimal(base_size = 13) +
theme(
plot.title.position = "plot",
panel.grid.minor = element_blank(),
axis.text.x = element_text(size = 11),
axis.text.y = element_text(size = 11)
)
library(tidyverse)
# Load PCE data (price index level + nominal expenditure shares)
# If duplicates exist, keeping "first" can be risky; but you said data is clean/present.
pce <- read_csv("data/pce_data.csv") %>%
distinct(date, item_name, .keep_all = TRUE) %>%
mutate(date = as.Date(date)) %>%
filter(date >= as.Date("2010-01-01")) %>%
arrange(item_name, date)
library(tidyverse)
# Load PCE data (price index level + nominal expenditure shares)
# If duplicates exist, keeping "first" can be risky; but you said data is clean/present.
pce <- read_csv("data/pce_data.csv") %>%
distinct(date, item_name, .keep_all = TRUE) %>%
mutate(date = as.Date(date)) %>%
filter(date >= as.Date("2010-01-01")) %>%
arrange(item_name, date)
