TRUE ~ NA_character_
)
) %>%
filter(!is.na(food_type)) %>%
select(newid, food_type, amount)
# --- Collapse to CU-quarter totals (one record per CU) ---
food_q <- mt_food %>%
group_by(newid, ucc, food_type) %>%
summarise(
spend_ucc = max(amount, na.rm = TRUE),  # KEY FIX
.groups = "drop"
) %>%
group_by(newid, food_type) %>%
summarise(
spend = sum(spend_ucc, na.rm = TRUE),
.groups = "drop"
) %>%
pivot_wider(
names_from = food_type,
values_from = spend,
values_fill = 0
) %>%
mutate(food_total = food_at_home + food_away)
library(tidyverse)
library(janitor)
library(Hmisc)
# --- Files (one quarter) ---
mtbi_file <- "mtbi232.csv"
fmli_file <- "fmli232.csv"
# --- Read MTBI (UCC-coded spending records) ---
mt <- read_csv(
mtbi_file,
show_col_types = FALSE,
col_types = cols(
newid  = col_character(),
ucc    = col_double(),
cost_2 = col_double(),
ref_mo = col_double(),
ref_yr = col_double(),
.default = col_guess()
)
) %>%
clean_names()
# NOTE: In MTBI, the dollar amount is in cost_2; `cost` is not numeric.
mt_food <- mt %>%
mutate(
amount = cost_2,
food_type = case_when(
ucc >= 790000 & ucc < 800000 ~ "food_at_home",
ucc >= 800000 & ucc < 810000 ~ "food_away",
TRUE ~ NA_character_
)
) %>%
filter(!is.na(food_type)) %>%
select(newid, food_type, amount)
mt_food
library(tidyverse)
library(janitor)
library(Hmisc)
# ---- Files ----
mtbi_file <- "mtbi232.csv"
fmli_file <- "fmli232.csv"
# ---- Read MTBI ----
mt <- read_csv(
mtbi_file,
show_col_types = FALSE,
col_types = cols(
newid  = col_character(),
ucc    = col_double(),
cost_2 = col_double(),
ref_mo = col_double(),
ref_yr = col_double(),
.default = col_guess()
)
) %>%
clean_names()
# ---- Filter to food and define amount ----
mt_food <- mt %>%
mutate(
amount = cost_2,
food_type = case_when(
ucc >= 790000 & ucc < 800000 ~ "food_at_home",
ucc >= 800000 & ucc < 810000 ~ "food_away",
TRUE ~ NA_character_
)
) %>%
filter(!is.na(food_type)) %>%
select(newid, ucc, food_type, amount)
names(mt_food)
library(tidyverse)
library(janitor)
library(Hmisc)
# ---- Files ----
mtbi_file <- "mtbi232.csv"
fmli_file <- "fmli232.csv"
# ---- Read MTBI ----
mt <- read_csv(
mtbi_file,
show_col_types = FALSE,
col_types = cols(
newid  = col_character(),
ucc    = col_double(),
cost_2 = col_double(),
ref_mo = col_double(),
ref_yr = col_double(),
.default = col_guess()
)
) %>%
clean_names()
# ---- Filter to food and define amount ----
mt_food <- mt %>%
mutate(
amount = cost_2,
food_type = case_when(
ucc >= 790000 & ucc < 800000 ~ "food_at_home",
ucc >= 800000 & ucc < 810000 ~ "food_away",
TRUE ~ NA_character_
)
) %>%
filter(!is.na(food_type)) %>%
select(newid, ucc, food_type, amount)
food_q <- mt_food %>%
group_by(newid, ucc, food_type) %>%
summarise(
spend_ucc = max(amount, na.rm = TRUE),  # de-duplicate quarterly values
.groups = "drop"
) %>%
group_by(newid, food_type) %>%
summarise(
spend = sum(spend_ucc, na.rm = TRUE),
.groups = "drop"
) %>%
pivot_wider(
names_from = food_type,
values_from = spend,
values_fill = 0
) %>%
mutate(food_total = food_at_home + food_away)
library(tidyverse)
library(janitor)
library(Hmisc)
# ---- Files ----
mtbi_file <- "mtbi232.csv"
fmli_file <- "fmli232.csv"
# ---- Read MTBI ----
mt <- read_csv(
mtbi_file,
show_col_types = FALSE,
col_types = cols(
newid  = col_character(),
ucc    = col_double(),
cost_2 = col_double(),
ref_mo = col_double(),
ref_yr = col_double(),
.default = col_guess()
)
) %>%
clean_names()
# ---- Filter to food and define amount ----
mt_food <- mt %>%
mutate(
amount = cost_2,
food_type = case_when(
ucc >= 790000 & ucc < 800000 ~ "food_at_home",
ucc >= 800000 & ucc < 810000 ~ "food_away",
TRUE ~ NA_character_
)
) %>%
filter(!is.na(food_type)) %>%
select(newid, ucc, food_type, amount)
food_q <- mt_food %>%
group_by(newid, ucc, food_type) %>%
summarise(
spend_ucc = max(amount, na.rm = TRUE),  # de-duplicate quarterly values
.groups = "drop"
) %>%
group_by(newid, food_type) %>%
summarise(
spend = sum(spend_ucc, na.rm = TRUE),
.groups = "drop"
) %>%
pivot_wider(
names_from = food_type,
values_from = spend,
values_fill = 0
) %>%
mutate(food_total = food_at_home + food_away)
fmli <- read_csv(
fmli_file,
show_col_types = FALSE,
col_types = cols(newid = col_character(), .default = col_guess())
) %>%
clean_names()
d_q <- fmli %>%
select(newid, finlwt21) %>%
left_join(food_q, by = "newid") %>%
mutate(
food_at_home = replace_na(food_at_home, 0),
food_away    = replace_na(food_away, 0),
food_total   = replace_na(food_total, 0)
)
d_q
library(tidyverse)
library(janitor)
library(Hmisc)
# ---- Files ----
mtbi_file <- "mtbi232.csv"
fmli_file <- "fmli232.csv"
# ---- Read MTBI ----
mt <- read_csv(
mtbi_file,
show_col_types = FALSE,
col_types = cols(
newid  = col_character(),
ucc    = col_double(),
cost_2 = col_double(),
ref_mo = col_double(),
ref_yr = col_double(),
.default = col_guess()
)
) %>%
clean_names()
# ---- Filter to food and define amount ----
mt_food <- mt %>%
mutate(
amount = cost_2,
food_type = case_when(
ucc >= 790000 & ucc < 800000 ~ "food_at_home",
ucc >= 800000 & ucc < 810000 ~ "food_away",
TRUE ~ NA_character_
)
) %>%
filter(!is.na(food_type)) %>%
select(newid, ucc, food_type, amount)
food_q <- mt_food %>%
group_by(newid, ucc, food_type) %>%
summarise(
spend_ucc = max(amount, na.rm = TRUE),  # de-duplicate quarterly values
.groups = "drop"
) %>%
group_by(newid, food_type) %>%
summarise(
spend = sum(spend_ucc, na.rm = TRUE),
.groups = "drop"
) %>%
pivot_wider(
names_from = food_type,
values_from = spend,
values_fill = 0
) %>%
mutate(food_total = food_at_home + food_away)
fmli <- read_csv(
fmli_file,
show_col_types = FALSE,
col_types = cols(newid = col_character(), .default = col_guess())
) %>%
clean_names()
d_q <- fmli %>%
select(newid, finlwt21) %>%
left_join(food_q, by = "newid") %>%
mutate(
food_at_home = replace_na(food_at_home, 0),
food_away    = replace_na(food_away, 0),
food_total   = replace_na(food_total, 0)
)
probs <- c(.10, .25, .50, .75, .90, .95, .99)
out <- tibble(
stat = c(
paste0("p", probs * 100),
"weighted_mean",
"unweighted_mean",
"n_cu"
),
food_total = c(
as.numeric(wtd.quantile(d_q$food_total, d_q$finlwt21, probs)),
wtd.mean(d_q$food_total, d_q$finlwt21),
mean(d_q$food_total),
nrow(d_q)
),
food_at_home = c(
as.numeric(wtd.quantile(d_q$food_at_home, d_q$finlwt21, probs)),
wtd.mean(d_q$food_at_home, d_q$finlwt21),
mean(d_q$food_at_home),
nrow(d_q)
),
food_away = c(
as.numeric(wtd.quantile(d_q$food_away, d_q$finlwt21, probs)),
wtd.mean(d_q$food_away, d_q$finlwt21),
mean(d_q$food_away),
nrow(d_q)
)
)
out
mt_food %>%
filter(food_type == "food_away") %>%
count(expname, rtype, sort = TRUE) %>%
slice_head(n = 20)
mt_food %>%
filter(food_type == "food_away")
mt_food %>%
filter(food_type == "food_away") %>%
count(expname, ucc, sort = TRUE) %>%
slice_head(n = 20)
mt_food %>%
filter(food_type == "food_away") %>%
count(ucc, sort = TRUE) %>%
slice_head(n = 20)
library(tidyverse)
library(janitor)
library(Hmisc)
library(cepumd)
library(tidyverse)
library(janitor)
library(Hmisc)
library(cepumd)
bls_food_crosswalk <- c(
# Food at home
"CXUFOODHOMELB0102M" = "Food at home: Lowest 20 percent income quintile",
"CXUFOODHOMELB0103M" = "Food at home: Second 20 percent income quintile",
"CXUFOODHOMELB0104M" = "Food at home: Third 20 percent income quintile",
"CXUFOODHOMELB0105M" = "Food at home: Fourth 20 percent income quintile",
"CXUFOODHOMELB0106M" = "Food at home: Highest 20 percent income quintile",
# Food away from home
"CXUFOODAWAYLB0102M" = "Food away from home: Lowest 20 percent income quintile",
"CXUFOODAWAYLB0103M" = "Food away from home: Second 20 percent income quintile",
"CXUFOODAWAYLB0104M" = "Food away from home: Third 20 percent income quintile",
"CXUFOODAWAYLB0105M" = "Food away from home: Fourth 20 percent income quintile",
"CXUFOODAWAYLB0106M" = "Food away from home: Highest 20 percent income quintile"
)
library(tidyverse)
library(janitor)
library(Hmisc)
library(cepumd)
bls_food_crosswalk <- c(
# Food at home
"CXUFOODHOMELB0102M" = "Food at home: Lowest 20 percent income quintile",
"CXUFOODHOMELB0103M" = "Food at home: Second 20 percent income quintile",
"CXUFOODHOMELB0104M" = "Food at home: Third 20 percent income quintile",
"CXUFOODHOMELB0105M" = "Food at home: Fourth 20 percent income quintile",
"CXUFOODHOMELB0106M" = "Food at home: Highest 20 percent income quintile",
# Food away from home
"CXUFOODAWAYLB0102M" = "Food away from home: Lowest 20 percent income quintile",
"CXUFOODAWAYLB0103M" = "Food away from home: Second 20 percent income quintile",
"CXUFOODAWAYLB0104M" = "Food away from home: Third 20 percent income quintile",
"CXUFOODAWAYLB0105M" = "Food away from home: Fourth 20 percent income quintile",
"CXUFOODAWAYLB0106M" = "Food away from home: Highest 20 percent income quintile"
)
library(blsAPI)
# Install and load blsR if you haven't already
# install.packages("blsR")
library(blsR)
library(dplyr)
# 1. Define your Series IDs
food_series_ids <- c(
"CXUFOODHOMELB0102M", "CXUFOODHOMELB0103M", "CXUFOODHOMELB0104M",
"CXUFOODHOMELB0105M", "CXUFOODHOMELB0106M",
"CXUFOODAWAYLB0102M", "CXUFOODAWAYLB0103M", "CXUFOODAWAYLB0104M",
"CXUFOODAWAYLB0105M", "CXUFOODAWAYLB0106M"
)
# 2. Define the naming crosswalk
bls_food_names <- c(
"CXUFOODHOMELB0102M" = "Home: Lowest 20%",
"CXUFOODHOMELB0103M" = "Home: Second 20%",
"CXUFOODHOMELB0104M" = "Home: Third 20%",
"CXUFOODHOMELB0105M" = "Home: Fourth 20%",
"CXUFOODHOMELB0106M" = "Home: Highest 20%",
"CXUFOODAWAYLB0102M" = "Away: Lowest 20%",
"CXUFOODAWAYLB0103M" = "Away: Second 20%",
"CXUFOODAWAYLB0104M" = "Away: Third 20%",
"CXUFOODAWAYLB0105M" = "Away: Fourth 20%",
"CXUFOODAWAYLB0106M" = "Away: Highest 20%"
)
# 3. Request the data
# blsR's get_n_series_table handles multiple IDs and returns a clean data frame
food_data_raw <- get_n_series_table(
food_series_ids,
start_year = 2014,
end_year = 2024,
# api_key = "YOUR_API_KEY" # Optional: add your key here to get more than 2 years
)
# 4. Rename and Tidy the data
food_data_final <- food_data_raw %>%
rename_with(~ bls_food_names[.x], .cols = any_of(names(bls_food_names))) %>%
tidyr::pivot_longer(
cols = starts_with(c("Home", "Away")),
names_to = "Category_Quintile",
values_to = "Expenditure"
) %>%
tidyr::separate(Category_Quintile, into = c("Location", "Quintile"), sep = ": ")
# Preview results
print(head(food_data_final))
food_data_final
food_data_raw
library(blsR)
library(dplyr)
library(tidyr)
# 1. Define the complete Series ID list
# We add CXUTOTALEXP... for the quintiles
food_series_ids <- c(
# Food at Home
"CXUFOODHOMELB0102M", "CXUFOODHOMELB0103M", "CXUFOODHOMELB0104M", "CXUFOODHOMELB0105M", "CXUFOODHOMELB0106M",
# Food Away from Home
"CXUFOODAWAYLB0102M", "CXUFOODAWAYLB0103M", "CXUFOODAWAYLB0104M", "CXUFOODAWAYLB0105M", "CXUFOODAWAYLB0106M",
# Total Expenditures
"CXUTOTALEXPLB0102M", "CXUTOTALEXPLB0103M", "CXUTOTALEXPLB0104M", "CXUTOTALEXPLB0105M", "CXUTOTALEXPLB0106M"
)
# 2. Map IDs to readable labels
bls_map <- c(
"CXUFOODHOMELB"  = "Food_Home",
"CXUFOODAWAYLB"  = "Food_Away",
"CXUTOTALEXPLB"  = "Total_Exp"
)
quintile_map <- c(
"0102M" = "Lowest 20%",
"0103M" = "Second 20%",
"0104M" = "Third 20%",
"0105M" = "Fourth 20%",
"0106M" = "Highest 20%"
)
# 3. Request data
# Note: For years 2014-2024, an API key is highly recommended
raw_data <- get_n_series_table(
food_series_ids,
start_year = 2014,
end_year = 2024
)
# 4. Tidy and Calculate Percentages
food_analysis <- raw_data %>%
pivot_longer(cols = -year, names_to = "series_id", values_to = "value") %>%
mutate(
# Extract prefix and suffix to identify category and quintile
category_id = substr(series_id, 1, 13),
quintile_id = substr(series_id, 14, 18),
category    = bls_map[category_id],
quintile    = quintile_map[quintile_id]
) %>%
select(year, quintile, category, value) %>%
# Spread categories into columns to calculate percentages
pivot_wider(names_from = category, values_from = value) %>%
mutate(
pct_food_home  = (Food_Home / Total_Exp) * 100,
pct_food_away  = (Food_Away / Total_Exp) * 100,
pct_total_food = ((Food_Home + Food_Away) / Total_Exp) * 100
)
library(blsR)
library(dplyr)
library(tidyr)
# 1. Define the complete Series ID list
food_series_ids <- c(
"CXUFOODHOMELB0102M", "CXUFOODHOMELB0103M", "CXUFOODHOMELB0104M", "CXUFOODHOMELB0105M", "CXUFOODHOMELB0106M",
"CXUFOODAWAYLB0102M", "CXUFOODAWAYLB0103M", "CXUFOODAWAYLB0104M", "CXUFOODAWAYLB0105M", "CXUFOODAWAYLB0106M",
"CXUTOTALEXPLB0102M", "CXUTOTALEXPLB0103M", "CXUTOTALEXPLB0104M", "CXUTOTALEXPLB0105M", "CXUTOTALEXPLB0106M"
)
# 2. Request data
# Note: Without a key, BLS API defaults to the most recent 2 years.
raw_data <- get_n_series_table(
food_series_ids,
start_year = 2014,
end_year = 2024
)
# 3. Tidy and Calculate Percentages
food_analysis <- raw_data %>%
# FIX: Exclude both 'year' AND 'period' from the pivot
pivot_longer(
cols = -c(year, period),
names_to = "series_id",
values_to = "value"
) %>%
mutate(
# Identify the category based on the Series ID string
category = case_when(
grepl("FOODHOME", series_id) ~ "Food_Home",
grepl("FOODAWAY", series_id) ~ "Food_Away",
grepl("TOTALEXP", series_id) ~ "Total_Exp"
),
# Identify the quintile based on the suffix
quintile = case_when(
grepl("0102M$", series_id) ~ "Lowest 20%",
grepl("0103M$", series_id) ~ "Second 20%",
grepl("0104M$", series_id) ~ "Third 20%",
grepl("0105M$", series_id) ~ "Fourth 20%",
grepl("0106M$", series_id) ~ "Highest 20%"
)
) %>%
filter(!is.na(value)) %>%
select(year, quintile, category, value) %>%
# Spread categories into columns
pivot_wider(names_from = category, values_from = value) %>%
# Calculate budget shares
mutate(
pct_food_home  = (Food_Home / Total_Exp) * 100,
pct_food_away  = (Food_Away / Total_Exp) * 100,
pct_total_food = ((Food_Home + Food_Away) / Total_Exp) * 100
)
# Preview the results
print(food_analysis %>% arrange(year, quintile))
ggplot(food_analysis, aes(year, pct_total_food)) + geom_line() +
facet_wrap(~quintile)
ggplot(food_analysis, aes(year, Food_Home)) + geom_line() +
facet_wrap(~quintile)
ggplot(food_analysis, aes(year, Food_Away)) + geom_line() +
facet_wrap(~quintile)
ggplot(food_analysis, aes(year, Total_Exp)) + geom_line() +
facet_wrap(~quintile)
ggplot(food_analysis, aes(year, pct_food_home)) + geom_line() +
facet_wrap(~quintile)
ggplot(food_analysis, aes(year, Food_Away)) + geom_line() +
facet_wrap(~quintile)
ggplot(food_analysis, aes(year, pct_food_away)) + geom_line() +
facet_wrap(~quintile)
ggplot(food_analysis, aes(year, pct_food_home)) + geom_line() +
facet_wrap(~quintile)
