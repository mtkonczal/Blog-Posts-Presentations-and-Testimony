---
title: "College-Educated Unemployment is Too High to Be Justified by the Weak Labor Market"
author: "Mike Konczal"
date: today
date-format: "MMMM D, YYYY"
format:
  html:
    code-fold: true
    code-summary: "Show code"
execute:
  echo: true
  message: false
  warning: false
---


```{r setup}
#| echo: false
library(tidyverse)
library(lubridate)
library(broom)
library(janitor)
library(slider)
library(scales)
library(blsR)
library(zoo)

bls_set_key(Sys.getenv("BLS_KEY"))

my_style <- list(
  theme_classic(base_size = 13),
  theme(
    axis.line = element_line(linewidth = 0.25),
    panel.grid.major.y = element_line(color = "gray85", linewidth = 0.25),
    panel.grid.major.x = element_line(color = "gray85", linewidth = 0.25),
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "bold"),
    plot.title.position = "plot",
    legend.position = "top",
    legend.title = element_blank()
  ),
  coord_cartesian(clip = "off")
)

# Output settings for blog-sized figures.
plot_dir <- "graphics"
dir.create(plot_dir, showWarnings = FALSE, recursive = TRUE)
plot_width <- 6.0
plot_height <- 4.2
plot_dpi <- 225

# Helper function to fetch BLS series with interpolation for missing months
fetch_bls_series <- function(series_ids, start_year = 1994, end_year = 2025) {
  raw <- get_n_series_table(
    series_ids,
    start_year = start_year,
    end_year = end_year,
    api_key = bls_get_key()
  )

  df <- raw %>%
    mutate(
      month_num = as.integer(gsub("M", "", period)),
      date = as.Date(paste0(year, "-", month_num, "-01"))
    ) %>%
    select(date, all_of(series_ids)) %>%
    mutate(across(-date, as.numeric))

 # Interpolate missing months (e.g., October 2025)
  date_range <- seq(min(df$date), max(df$date), by = "month")
  df %>%
    right_join(tibble(date = date_range), by = "date") %>%
    arrange(date) %>%
    mutate(across(-date, ~ zoo::na.approx(.x, na.rm = FALSE)))
}

# Fetch unemployment rates for setup
setup_series <- fetch_bls_series(c(
  "LNS14000000",  # Total unemployment
  "LNS14000006",  # Black
  "LNS14027660",  # HS grad
  "LNS14027662",  # College
  "LNS14000001",  # Men
  "LNS14000093"   # Age 45-54
))

unrate <- setup_series %>%
  rename(
    full_unrate = LNS14000000,
    black_unrate = LNS14000006,
    hs_grad = LNS14027660,
    all_college = LNS14027662,
    men_unrate = LNS14000001,
    age_45_54 = LNS14000093
  ) %>%
  mutate(across(-date, ~ .x / 100)) %>%
  filter(year(date) >= 1994)
```

```{r men_45_54_comparison}

# ---- Fit log-log models pre-2020 ----
model_men <- lm(log(men_unrate) ~ log(full_unrate), data = unrate %>% filter(year(date) < 2020))
model_45_54 <- lm(log(age_45_54) ~ log(full_unrate), data = unrate %>% filter(year(date) < 2020))

# ---- Add predictions (exponentiate back) ----
unrate <- unrate %>%
  mutate(
    predict_men = exp(predict(model_men, newdata = unrate)),
    predict_45_54 = exp(predict(model_45_54, newdata = unrate))
  )

# ---- Long format for 4-line plot ----
plot_df <- unrate %>%
  transmute(
    date,
    men_actual = men_unrate,
    men_proj = predict_men,
    age_actual = age_45_54,
    age_proj = predict_45_54
  ) %>%
  pivot_longer(-date, names_to = "series", values_to = "value") %>%
  mutate(
    group = case_when(
      str_detect(series, "^men_") ~ "Men",
      str_detect(series, "^age_") ~ "Ages 45-54"
    ),
    type = case_when(
      str_detect(series, "_actual$") ~ "Actual",
      str_detect(series, "_proj$") ~ "Projection"
    )
  )

# ---- Colors ----
group_cols <- c("Men" = "#2c3254", "Ages 45-54" = "#d95f02")

# ---- Full history plot (Figure 1.a) ----
fig_1a <- plot_df %>%
  ggplot(aes(x = date, y = value, color = group, linetype = type)) +
  geom_line(aes(alpha = type), linewidth = 1) +
  scale_color_manual(values = group_cols) +
  scale_linetype_manual(values = c("Actual" = "solid", "Projection" = "dotted")) +
  scale_alpha_manual(values = c("Actual" = 1, "Projection" = 0.8), guide = "none") +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  labs(
    title = "Figure 1.a: Unemployment Rates Track Their Historical Relationship",
    subtitle = "Unemployment rates: Actual vs. trend predicted by overall unemployment (1994-2019)",
    x = NULL,
    y = NULL,
    color = NULL,
    linetype = NULL,
    caption = "Source: BLS, Author's Calculations, Mike Konczal"
  ) +
  my_style

ggsave(
  filename = file.path(plot_dir, "figure-1a.png"),
  plot = fig_1a,
  width = plot_width,
  height = plot_height,
  dpi = plot_dpi
)
fig_1a
```


```{r men_45_54_recent}
# ---- Post-2021 zoom plot (Figure 1.b) ----
fig_1b <- plot_df %>%
  filter(year(date) >= 2021) %>%
  ggplot(aes(x = date, y = value, color = group, linetype = type)) +
  geom_line(aes(alpha = type), linewidth = 1.2) +
  scale_color_manual(values = group_cols) +
  scale_linetype_manual(values = c("Actual" = "solid", "Projection" = "dotted")) +
  scale_alpha_manual(values = c("Actual" = 1, "Projection" = 0.8), guide = "none") +
  scale_y_continuous(labels = percent_format(accuracy = 0.1)) +
  labs(
    title = "Figure 1.b: Recent Years - Still Tracking Historical Patterns",
    subtitle = "Unemployment rates: Actual vs. trend predicted by overall unemployment (1994-2019)",
    x = NULL,
    y = NULL,
    color = NULL,
    linetype = NULL,
    caption = "Source: BLS, Author's Calculations, Mike Konczal"
  ) +
  my_style

ggsave(
  filename = file.path(plot_dir, "figure-1b.png"),
  plot = fig_1b,
  width = plot_width,
  height = plot_height,
  dpi = plot_dpi
)
fig_1b
```



```{r all_unrates_barchart}
# ---- Pull data using BLS API ----
all_series_raw <- fetch_bls_series(c(
  "LNS14000000",  # Total
  "LNS14000001",  # Men
  "LNS14000002",  # Women
  "LNS14000003",  # White
  "LNS14000006",  # Black
  "LNS14000009",  # Hispanic
  "LNS14000012",  # Age 16-19
  "LNS14000036",  # Age 20-24
  "LNS14000089",  # Age 25-34
  "LNS14000091",  # Age 35-44
  "LNS14000093",  # Age 45-54
  "LNS14024230",  # Age 55+
  "LNS14027659",  # < HS

  "LNS14027660",  # HS only
  "LNS14027689",  # Some college
  "LNS14027662"   # BA+
))

# Rename columns
all_series <- all_series_raw %>%
  rename(
    total = LNS14000000,
    men = LNS14000001,
    women = LNS14000002,
    white = LNS14000003,
    black = LNS14000006,
    hispanic = LNS14000009,
    age_16_19 = LNS14000012,
    age_20_24 = LNS14000036,
    age_25_34 = LNS14000089,
    age_35_44 = LNS14000091,
    age_45_54 = LNS14000093,
    age_55_plus = LNS14024230,
    edu_lt_hs = LNS14027659,
    edu_hs = LNS14027660,
    edu_some_college = LNS14027689,
    edu_ba_plus = LNS14027662
  )

# ---- Pivot to long format ----
all_long <- all_series %>%
  pivot_longer(-date, names_to = "series_name", values_to = "value") %>%
  filter(!is.na(value))

# ---- Get total unemployment as regressor ----
total_unrate <- all_long %>%
  filter(series_name == "total") %>%
  select(date, total_unrate = value)

# ---- Join and prepare regression panel ----
regression_panel <- all_long %>%
  filter(series_name != "total") %>%
  left_join(total_unrate, by = "date") %>%
  filter(!is.na(total_unrate))

# ---- Fit per-series log-log models (train through 2019) + predict all dates ----
fit_loglog_model <- function(df) {
  train_data <- df %>% filter(year(date) <= 2019)
  if (nrow(train_data) < 12) {
    # Not enough training data, return empty
    return(df %>% mutate(prediction = NA_real_, diff = NA_real_) %>% filter(FALSE))
  }
  mod <- lm(log(value) ~ log(total_unrate), data = train_data)
  df %>%
    mutate(
      prediction = exp(predict(mod, newdata = df)),
      diff = value - prediction
    )
}

results <- regression_panel %>%
  filter(value > 0, total_unrate > 0) %>%
  group_by(series_name) %>%
  group_modify(~ fit_loglog_model(.x)) %>%
  ungroup() %>%
  filter(!is.na(diff))

# ---- Average (actual - predicted) over last 2 months, per series ----
last_date <- max(results$date, na.rm = TRUE)
cutoff <- floor_date(last_date %m-% months(1), unit = "month")  # 2 months inclusive

avg_diff_2m <- results %>%
  filter(date >= cutoff) %>%
  group_by(series_name) %>%
  summarise(
    avg_diff_2m = mean(diff, na.rm = TRUE),
    .groups = "drop"
  )

# ---- Create nice labels ----
label_lookup <- c(
  men = "Men", women = "Women",
  white = "White", black = "Black", hispanic = "Hispanic", asian = "Asian",
  age_16_19 = "Age 16-19", age_20_24 = "Age 20-24", age_25_34 = "Age 25-34",
  age_35_44 = "Age 35-44", age_45_54 = "Age 45-54", age_55_plus = "Age 55+",
  edu_lt_hs = "< High school (25+)", edu_hs = "HS only (25+)",
  edu_some_college = "Some college (25+)", edu_ba_plus = "BA+ (25+)"
)

avg_diff_2m <- avg_diff_2m %>%
  mutate(label = label_lookup[series_name]) %>%
  filter(!is.na(label)) %>%
  arrange(avg_diff_2m)

# ---- Bar chart ----
fig_2 <- ggplot(avg_diff_2m, aes(x = avg_diff_2m, y = reorder(label, avg_diff_2m))) +
  geom_col(fill = "#2c3254") +
  geom_vline(xintercept = 0, linewidth = 0.5) +
  scale_x_continuous(labels = function(x) paste0(x, " pp")) +
  labs(
    title = "Figure 2: Average Actual Minus Predicted Unemployment",
    subtitle = paste0(
      "Average over last 2 months (",
      format(cutoff, "%b %Y"), " to ", format(last_date, "%b %Y"),
      "); model trained through 2019"
    ),
    x = "Avg (Actual - Predicted), percentage points",
    y = NULL,
    caption = "Source: BLS, Author's Calculations, Mike Konczal"
  ) +
  my_style

ggsave(
  filename = file.path(plot_dir, "figure-2.png"),
  plot = fig_2,
  width = plot_width,
  height = plot_height,
  dpi = plot_dpi
)
fig_2

```



```{r black_unrate}

# ---- Fit model pre-2020: Black unemployment on overall unemployment ----
model_black <- lm(
  log(black_unrate) ~ log(full_unrate),
  data = unrate %>% filter(year(date) < 2020)
)

# ---- Add prediction ----
unrate <- unrate %>%
  mutate(predict_black = exp(predict(model_black, newdata = unrate)))

# ---- Long format for 2-line plot ----
plot_black <- unrate %>%
  transmute(
    date,
    actual = black_unrate,
    projection = predict_black
  ) %>%
  pivot_longer(-date, names_to = "type", values_to = "value") %>%
  mutate(
    type = recode(type, actual = "Actual", projection = "Projection")
  )

# ---- Full history plot (Figure 3.a) ----
fig_3a <- plot_black %>%
  ggplot(aes(x = date, y = value, color = type, linetype = type)) +
  geom_line(linewidth = 1) +
  scale_color_manual(values = c("Actual" = "#2c3254", "Projection" = "gray50")) +
  scale_linetype_manual(values = c("Actual" = "solid", "Projection" = "dotted")) +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  labs(
    title = "Figure 3.a: Black Unemployment Tracks Its Historical Trend",
    subtitle = "Black unemployment rate: Actual vs. predicted from overall unemployment (1994-2019)",
    x = NULL,
    y = NULL,
    color = NULL,
    linetype = NULL,
    caption = "Source: BLS, Author's Calculations, Mike Konczal"
  ) +
  my_style

ggsave(
  filename = file.path(plot_dir, "figure-3a.png"),
  plot = fig_3a,
  width = plot_width,
  height = plot_height,
  dpi = plot_dpi
)
fig_3a

# ---- Post-2021 zoom plot (Figure 3.b) ----
fig_3b <- plot_black %>%
  filter(year(date) >= 2021) %>%
  ggplot(aes(x = date, y = value, color = type, linetype = type)) +
  geom_line(linewidth = 1.2) +
  scale_color_manual(values = c("Actual" = "#2c3254", "Projection" = "gray50")) +
  scale_linetype_manual(values = c("Actual" = "solid", "Projection" = "dotted")) +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  labs(
    title = "Figure 3.b: Black Unemployment Returns to Historical Trend",
    subtitle = "Black unemployment rate: Actual vs. predicted from overall unemployment (1994-2019)",
    x = NULL,
    y = NULL,
    color = NULL,
    linetype = NULL,
    caption = "Source: BLS, Author's Calculations, Mike Konczal"
  ) +
  my_style

ggsave(
  filename = file.path(plot_dir, "figure-3b.png"),
  plot = fig_3b,
  width = plot_width,
  height = plot_height,
  dpi = plot_dpi
)
fig_3b
```



```{r young_unemployed}

# ---- Color choices ----
col_young <- "#004c6d"
col_grads <- "#ff8361"

# ---- Load + prep ----
compare <- read_csv("data/ny_fed_data/unemployed-Table 1.csv") %>%
  clean_names() %>%
  select(date:college_graduates) %>%
  mutate(
    date = mdy(date),
    young_workers     = young_workers / 100,
    recent_graduates  = recent_graduates / 100,
    all_workers       = all_workers / 100
  ) %>%
  arrange(date)

# ---- Models (fit pre-2020) ----
model_young <- lm(log(young_workers) ~ log(all_workers), data = compare %>% filter(year(date) < 2020))
model_grads <- lm(log(recent_graduates) ~ log(all_workers), data = compare %>% filter(year(date) < 2020))

compare <- compare %>%
  mutate(
    predict_young = exp(predict(model_young, newdata = compare)),
    predict_grads = exp(predict(model_grads, newdata = compare))
  )

# ---- Long format for 4-line plot ----
plot_df <- compare %>%
  transmute(
    date,
    young_actual = young_workers,
    young_proj   = predict_young,
    grads_actual = recent_graduates,
    grads_proj   = predict_grads
  ) %>%
  pivot_longer(-date, names_to = "series", values_to = "value") %>%
  mutate(
    group = case_when(
      str_detect(series, "^young_") ~ "All other non-college graduates (ages 22-27)",
      str_detect(series, "^grads_") ~ "Recent college graduates (ages 22-27)"
    ),
    type = case_when(
      str_detect(series, "_actual$") ~ "Actual",
      str_detect(series, "_proj$")   ~ "Projection"
    )
  )

# ---- Full history plot (Figure 4.a) ----
fig_4a <- plot_df %>%
  ggplot(aes(x = date, y = value, color = group, linetype = type)) +
  geom_line(aes(alpha = type), linewidth = 1) +
  scale_color_manual(values = c(
    "All other non-college graduates (ages 22-27)" = col_young,
    "Recent college graduates (ages 22-27)" = col_grads
  )) +
  scale_linetype_manual(values = c("Actual" = "solid", "Projection" = "dotted")) +
  scale_alpha_manual(values = c("Actual" = 1, "Projection" = 0.8), guide = "none") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(
    title = "Figure 4.a: Young College-Educated Unemployment No Longer Tracks Overall",
    subtitle = "Unemployment rates (ages 22-27): Actual vs. trend predicted by overall unemployment rate (1990-2019)",
    x = NULL,
    y = NULL,
    color = NULL,
    linetype = NULL,
    caption = "Source: NY Fed, Author's Calculations, Mike Konczal"
  ) +
  my_style

ggsave(
  filename = file.path(plot_dir, "figure-4a.png"),
  plot = fig_4a,
  width = plot_width,
  height = plot_height,
  dpi = plot_dpi
)
fig_4a

# ---- Post-2017 zoom plot (Figure 4.b) ----
fig_4b <- plot_df %>%
  filter(year(date) >= 2017) %>%
  ggplot(aes(x = date, y = value, color = group, linetype = type)) +
  geom_line(aes(alpha = type), linewidth = 1.2) +
  scale_color_manual(values = c(
    "All other non-college graduates (ages 22-27)" = col_young,
    "Recent college graduates (ages 22-27)" = col_grads
  )) +
  scale_linetype_manual(values = c("Actual" = "solid", "Projection" = "dotted")) +
  scale_alpha_manual(values = c("Actual" = 1, "Projection" = 0.8), guide = "none") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(
    title = "Figure 4.b: Recent College Graduates Have Higher Unemployment\nThan Predicted From Slowing Labor Market",
    subtitle = "Unemployment rates (ages 22-27): Actual vs. trend predicted by overall unemployment rate (1990-2019)",
    x = NULL,
    y = NULL,
    color = NULL,
    linetype = NULL,
    caption = "Source: NY Fed, Author's Calculations, Mike Konczal"
  ) +
  my_style

ggsave(
  filename = file.path(plot_dir, "figure-4b.png"),
  plot = fig_4b,
  width = plot_width,
  height = plot_height,
  dpi = plot_dpi
)
fig_4b
```


```{r ba_non_ba_by_age}
# Assuming age_diff.csv exists in your directory
age_diff <- read_csv("data/age_diff.csv")

# ── One graphic: age on x, avg residual on y ─────────────────────────────
fig_5 <- ggplot(age_diff, aes(x = center_age, y = diff_avg, color = edu_group)) +
  geom_hline(yintercept = 0, linewidth = 0.8, color = "gray40") +
  geom_line(linewidth = 1.3) +
  geom_point(size = 3) +
  scale_color_manual(values = c("College+" = "#2c3254", "HS+ (no BA)" = "#e07b53")) +
  scale_y_continuous(labels = percent_format(accuracy = 0.1)) +
  scale_x_continuous(breaks = seq(20, 65, 5), limits = c(19, 65)) +
  labs(
    title = "Figure 5: Actual Minus Projected Unemployment by Age",
    subtitle = paste0(
      "Average residual (Actual - Predicted) over 3 months prior to Sept 2025; log-log model trained 1989-2019"
    ),
    x = "Center age (band is center ±1 year)",
    y = "Avg Residual (Actual - Proj)",
    color = NULL,
    caption = "Source: CPS Microdata, Author's Calculations, Mike Konczal"
  ) +
  my_style

ggsave(
  filename = file.path(plot_dir, "figure-5.png"),
  plot = fig_5,
  width = plot_width,
  height = plot_height,
  dpi = plot_dpi
)
fig_5

```

